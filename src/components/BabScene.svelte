<script>
  import * as BABYLON from "babylonjs";
  import { onMount } from "svelte";
  //component
  let myCanvas;
  let mounted = false;
  let clickable = true;
  let zFront = true;

  //scene management
  let engine;
  let camera1;
  let scene;
  let physicsEnabled = false;
  let ground;
  let currentStep;
  const CUBE_COLOR = "#000045";
  const DEBUG_VIEW = false;
  const STEP_INTRO = "intro";
  const STEP_BROWSING = "browsing";
  //intro scene
  let nbCuberHoriz, nbCubesVert;
  let svgData;
  let boxes;
  let balls;
  let cubesDown = 0;
  const NB_CUBES = 100;
  const B_SIZE = 10;
  const C_SIZE = 3;
  const GROUND_LENGTH = 3;
  //browsing
  let cube1, cube2, cube3;
  let browsingCamera;
  let scrollPos;
  let oldPos = 0;
  let nativeSpeed = 0.001;

  function cannonLoaded() {}

  onMount(() => {
    mounted = true;
    engine = new BABYLON.Engine(myCanvas, true);
    scene = new BABYLON.Scene(engine);
    // scene.clearColor = BABYLON.Color3.FromHexString(BG_COLOR);
    scene.clearColor = new BABYLON.Color4(0, 0, 0, 0);

    var gravityVectorOn = new BABYLON.Vector3(0, -9.81 * 5, 0);
    var gravityVectorOff = new BABYLON.Vector3(0, 0, 0);
    var physicsPlugin = new BABYLON.CannonJSPlugin();
    scene.enablePhysics(gravityVectorOn, physicsPlugin);

    setupIntro();

    if (DEBUG_VIEW) {
      camera1 = new BABYLON.ArcRotateCamera(
        "Camera",
        Math.PI / 2,
        Math.PI / 2,
        20,
        new BABYLON.Vector3(0, 5, 0),
        scene
      );
      var camera2 = new BABYLON.ArcRotateCamera(
        "camera1",
        Math.PI / 3,
        Math.PI / 3,
        70,
        new BABYLON.Vector3(0, 2, 0),
        scene
      );
      camera2.attachControl(myCanvas, true);
      camera1.viewport = new BABYLON.Viewport(0, 0.3, 1, 0.7);
      camera2.viewport = new BABYLON.Viewport(0, 0, 0.3, 0.3);
      scene.activeCameras.push(camera2);
      scene.activeCameras.push(camera1);
    } else {
      // camera1 = new BABYLON.ArcRotateCamera("Camera",Math.PI/2, Math.PI/2, 20, new BABYLON.Vector3(0, 5, 0), scene);
      camera1 = new BABYLON.UniversalCamera(
        "Camera",
        new BABYLON.Vector3(0, (nbCubesVert * C_SIZE) / 2, -50),
        scene
      );
      camera1.fovMode = BABYLON.Camera.FOVMODE_HORIZONTAL_FIXED;
      camera1.setTarget(new BABYLON.Vector3(0, (nbCubesVert * C_SIZE) / 2, 0));
      // camera1.attachControl(myCanvas, true);
      camera1.fov = getFOV(camera1);
    }

    var light = new BABYLON.HemisphericLight(
      "light1",
      new BABYLON.Vector3(0, 1, 0),
      scene
    );
    if (DEBUG_VIEW) addGUI();

    scene.onPointerObservable.add(pointerInfo => {
      switch (pointerInfo.type) {
        case BABYLON.PointerEventTypes.POINTERUP:
          if (currentStep == STEP_INTRO) launchBall();
          break;
        default:
      }
    });

    engine.runRenderLoop(renderScene);
  });
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  function renderScene() {
    if (currentStep == STEP_INTRO) {
      var cubesDown = 0;
      for (var i = 0; i < boxes.length; i++) {
        if (boxes[i].position.y < 0) cubesDown++;
      }
      if (cubesDown == boxes.length) {
        // On passe en mode background
        zFront = false;
        disposeIntro();
        setupBrowsing();
      } else if (cubesDown >= NB_CUBES * 0.8) {
        // On fait tomber les autres cubes
        clickable = false;
        ground.dispose();
      }
    } else if (currentStep == STEP_BROWSING) {
      var speed = (scrollPos - oldPos) / 1000;
      if (speed < 0) {
	nativeSpeed = -0.001;
      } else if (speed > 0) {
        nativeSpeed = 0.001;
      }

      oldPos = scrollPos;
      console.log(nativeSpeed, speed);

      cube1.rotation.y += nativeSpeed + speed;
      cube2.rotation.x += nativeSpeed + speed;
      cube3.rotation.z += nativeSpeed + speed;
    }

    if (scene) scene.render();
  }
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  function setupIntro(params) {
    currentStep = STEP_INTRO;
    balls = [];
    setNbCubes();
    ground = BABYLON.Mesh.CreateGround("ground1", 100, GROUND_LENGTH, 2, scene);
    ground.isVisible = DEBUG_VIEW;
    ground.physicsImpostor = new BABYLON.PhysicsImpostor(
      ground,
      BABYLON.PhysicsImpostor.BoxImpostor,
      { mass: 0, friction: 0.5, restitution: 0.7 },
      scene
    );
    var gdMaterial = new BABYLON.StandardMaterial("myMaterial", scene);
    ground.material = gdMaterial;
//     ground.dispose();
    svgData = getSVGData();
    addIntroCube();
  }

  function disposeIntro() {
    for (var i = 0; i < boxes.length; i++) {
      boxes[i].dispose();
    }
    for (var i = 0; i < balls.length; i++) {
      balls[i].dispose;
    }
  }
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  function setupBrowsing(params) {
    currentStep = STEP_BROWSING;
    browsingCamera = new BABYLON.TargetCamera(
      "brCam",
      new BABYLON.Vector3(0, 0, -5),
      scene
    );
    scene.activeCameras = [browsingCamera];
    cube1 = BABYLON.Mesh.CreateBox("cube1", 2, scene);
    cube1.rotation = new BABYLON.Vector3(0, Math.PI/4, 0);
//     cube1.material = getStandardMaterial("#FF0000");
    cube1.material = getStandardMaterial();

    cube2 = BABYLON.Mesh.CreateBox("cube2", 2, scene);
    cube2.rotation = new BABYLON.Vector3(Math.PI/4, 0, 0);
//     cube2.material = getStandardMaterial("#00FF00");
    cube2.material = getStandardMaterial();

    cube3 = BABYLON.Mesh.CreateBox("cube3", 2, scene);
    cube3.rotation = new BABYLON.Vector3(0, 0, Math.PI/4);
//     cube3.material = getStandardMaterial("#0000FF");
        cube3.material = getStandardMaterial();
  }
  function disposeBrowsing(params) {}

  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  function onResize(node) {
    engine.resize();
    camera1.fov = getFOV(camera1);
  }
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  function getIntroBoxMaterial(i, j) {
    var textMat = new BABYLON.StandardMaterial("dummy", scene);
    textMat.hasAlpha = true;
    // var textTexture =  new BABYLON.Texture("babylonjs/tagline.svg", scene);
    var encodedData = "data:image/svg+xml;base64," + window.btoa(svgData);
    var textTexture = BABYLON.Texture.LoadFromDataString(
      "svg",
      encodedData,
      scene
    );
    // textMat.alpha = .5;
    textMat.opacityTexture = textTexture;
    textMat.emissiveTexture = textTexture;
    textMat.getAlphaFromRGB = true;
    textMat.opacityTexture.vScale = 1 / nbCubesVert;
    textMat.opacityTexture.uScale = 1 / nbCuberHoriz;
    textMat.opacityTexture.vOffset = (1 / nbCubesVert) * i;
    textMat.opacityTexture.uOffset = (1 / nbCuberHoriz) * j;
    // textMat.useAlphaFromDiffuseTexture = true;

    var mainColor = new BABYLON.StandardMaterial("mat1", scene);
    mainColor.diffuseColor = BABYLON.Color3.FromHexString(CUBE_COLOR);
    var multimat = new BABYLON.MultiMaterial("multi", scene);
    multimat.subMaterials.push(mainColor);
    multimat.subMaterials.push(textMat);
    multimat.alpha = 0.5;

    return multimat;
  }
  ////////////////////////////////////////////////////////////////////////////////////////////////////// L x H = S -> L = S/H
  ////////////////////////////////////////////////////////////////////////////////////////////////////// 1000 x 500 = 500 000 -> 500 000 / 200 = 2500
  ////////////////////////////////////////////////////////////////////////////////////////////////////// 20   x 10  = 200
  function setNbCubes() {
    var ratio = Math.sqrt((myCanvas.width * myCanvas.height) / NB_CUBES);
    nbCubesVert = Math.round(myCanvas.height / ratio);
    nbCuberHoriz = Math.round(myCanvas.width / ratio);
  }

  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  function addIntroCube() {
    boxes = [];
    for (let i = 0; i < nbCubesVert; i++) {
      for (let j = 0; j < nbCuberHoriz; j++) {
        var box = BABYLON.Mesh.CreateBox("box" + i + j, C_SIZE, scene);
        box.position.x = j * C_SIZE - ((nbCuberHoriz - 1) * C_SIZE) / 2;
        box.position.y = i * C_SIZE + C_SIZE / 2;
        box.position.z = 0;
        // box.physicsImpostor = new BABYLON.PhysicsImpostor(box, BABYLON.PhysicsImpostor.BoxImpostor, { mass: .5, friction: 0.5, restitution: 0.7  }, scene);
        box.subMeshes = [];
        var verticesCount = box.getTotalVertices();
        box.subMeshes.push(
          new BABYLON.SubMesh(
            0,
            0,
            verticesCount,
            0,
            box.getTotalIndices(),
            box
          )
        );
        box.subMeshes.push(
          new BABYLON.SubMesh(
            1,
            0,
            verticesCount,
            0,
            box.getTotalIndices(),
            box
          )
        );
        box.material = getIntroBoxMaterial(i, j);
        box.convertToUnIndexedMesh();
        boxes.push(box);
      }
    }
    // if(DEBUG_VIEW) addDummy(camera1.position);
  }

  function addImpostors() {
    for (let i = 0; i < boxes.length; i++) {
      boxes[i].physicsImpostor = new BABYLON.PhysicsImpostor(
        boxes[i],
        BABYLON.PhysicsImpostor.BoxImpostor,
        { mass: 0.5, friction: 0.5, restitution: 0.7 },
        scene
      );
    }
  }
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  function getStandardMaterial(c = CUBE_COLOR) {
    var mat = new BABYLON.StandardMaterial("mat1", scene);
    mat.diffuseColor = BABYLON.Color3.FromHexString(c);
    return mat;
  }
  function launchBall() {
    if (!physicsEnabled) {
      addImpostors();
      physicsEnabled = true;
    }
    var pickResult = scene.pick(scene.pointerX, scene.pointerY);
    var ratioPointerX =
      ((scene.pointerX - myCanvas.width / 2) / myCanvas.width) * 2;
    var ratioPointerY =
      ((scene.pointerY - myCanvas.height / 2) / myCanvas.height) * 2;
    var ball = BABYLON.MeshBuilder.CreateSphere(
      "ball",
      { diameter: B_SIZE },
      scene
    );
    balls.push(ball);
    ball.material = getStandardMaterial();

    ball.position.x = pickResult.ray.origin.x + pickResult.ray.direction.x * 2;
    ball.position.y = pickResult.ray.origin.y + pickResult.ray.direction.y * 2;
    ball.position.z = pickResult.ray.origin.z + pickResult.ray.direction.z * 2;

    console.log("ratioPointerX,ratioPointerY : ", ratioPointerX, ratioPointerY);
    ball.physicsImpostor = new BABYLON.PhysicsImpostor(
      ball,
      BABYLON.PhysicsImpostor.SphereImpostor,
      { mass: 3, friction: 0.5, restitution: 0.7 },
      scene
    );
    var impulseDirection = new BABYLON.Vector3(
      ratioPointerX * C_SIZE * nbCuberHoriz,
      (-ratioPointerY + 0.5) * C_SIZE * nbCubesVert,
      0
    ).subtract(ball.position);
    var impulseMagnitude = 5;
    if (DEBUG_VIEW) {
      let rayHelper = new BABYLON.RayHelper(
        new BABYLON.Ray(impulseDirection, ball.position),
        1
      );
      rayHelper.show(scene, new BABYLON.Color3(1, 0, 0));
    }
    ball.physicsImpostor.applyImpulse(
      impulseDirection.scale(impulseMagnitude),
      ball.position
    );
  }
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  function getFOV(c) {
    var oppo = Math.abs((-nbCuberHoriz * C_SIZE) / 2);
    var adja = Math.abs(Math.abs(camera1.position.z) - C_SIZE / 2);
    return 2 * Math.atan(oppo / adja);
  }
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  function getSVGData() {
    // console.log(myCanvas.width);
    return (
      `<svg width="` +
      myCanvas.width +
      `" height="` +
      myCanvas.height +
      `" viewBox="0 0 1280 360" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M130.088 132H157.448V130.848H151.688V84.048L158.096 80.16H129.44L135.848 84.048V130.848H130.088V132ZM209.738 130.848V110.904C209.738 100.464 204.914 95.28 195.842 95.28C188.642 95.28 183.314 98.232 178.418 103.704L178.778 104.064C181.226 102.192 183.458 101.328 186.698 101.328C192.17 101.328 195.338 105.288 195.338 113.208C183.386 114.504 176.33 118.896 176.33 125.52C176.33 130.056 179.498 132.72 184.178 132.72C188.138 132.72 191.954 130.776 195.338 127.896V132H213.338V130.848H209.738ZM193.682 127.104C190.802 127.104 189.362 125.304 189.362 121.92C189.362 118.104 191.018 115.368 195.338 114.144V126.888C194.69 127.032 194.114 127.104 193.682 127.104ZM279.209 130.848V106.08C279.209 98.736 276.401 94.92 270.281 94.92C266.177 94.92 262.289 97.152 256.241 102.048C255.305 97.368 252.569 94.92 247.673 94.92C243.641 94.92 239.825 97.08 233.993 101.76V94.56L215.489 101.04L219.593 104.568V130.848H215.993V132H236.873V130.848H233.993V102.624C235.361 101.976 236.801 101.688 238.241 101.688C241.337 101.688 242.201 103.56 242.201 109.176V130.848H239.321V132H259.481V130.848H256.601V106.08C256.601 104.856 256.529 103.776 256.385 102.768C257.825 102.048 259.337 101.688 260.849 101.688C263.945 101.688 264.809 103.56 264.809 109.176V130.848H261.929V132H282.809V130.848H279.209ZM334.261 130.848V110.904C334.261 100.464 329.437 95.28 320.365 95.28C313.165 95.28 307.837 98.232 302.941 103.704L303.301 104.064C305.749 102.192 307.981 101.328 311.221 101.328C316.693 101.328 319.861 105.288 319.861 113.208C307.909 114.504 300.853 118.896 300.853 125.52C300.853 130.056 304.021 132.72 308.701 132.72C312.661 132.72 316.477 130.776 319.861 127.896V132H337.861V130.848H334.261ZM318.205 127.104C315.325 127.104 313.885 125.304 313.885 121.92C313.885 118.104 315.541 115.368 319.861 114.144V126.888C319.213 127.032 318.637 127.104 318.205 127.104ZM377.94 78C368.076 78 360.732 83.4 359.94 96.72H355.548V97.872H359.868V99.096V130.848H356.268V132H380.388V130.848H374.268V97.872H383.556V96.72H374.268V86.64C374.268 82.032 374.484 79.656 375.42 79.296C376.356 78.936 378.66 82.608 380.748 85.704L386.58 94.2H386.652L388.596 80.16C385.5 78.792 381.396 78 377.94 78ZM423.853 130.848V94.632L405.349 101.112L409.453 104.64V125.304C408.229 125.736 406.933 126.024 405.781 126.024C402.181 126.024 401.677 123.648 401.677 117.6V94.992L383.173 101.472L387.277 105V120.48C387.277 129.048 390.085 132.792 396.565 132.792C400.597 132.792 404.701 129.912 409.453 126.456V132H427.453V130.848H423.853ZM430.095 132H451.695V130.848H448.095V78L429.591 84.48L433.695 88.008V130.848H430.095V132ZM454.352 132H475.952V130.848H472.352V78L453.848 84.48L457.952 88.008V130.848H454.352V132ZM480.842 116.016H501.074V111.696H480.842V116.016ZM519.64 132.72C528.496 132.72 536.056 128.112 536.056 120.624C536.056 116.16 533.464 112.56 528.496 109.896L523.096 107.016C518.848 104.784 517.696 102.984 517.696 100.464C517.696 98.448 519.28 96.648 522.448 96.648C522.808 96.648 523.312 96.72 523.672 96.864L532.024 108.744H532.096L534.904 97.368C531.376 96.072 527.632 95.28 522.952 95.28C513.376 95.28 507.472 100.032 507.472 107.304C507.472 112.776 510.352 116.16 516.328 119.328L521.08 121.848C524.104 123.432 525.4 124.656 525.4 126.816C525.4 129.768 523.24 131.424 520.072 131.424C519.208 131.424 518.704 131.352 517.696 131.064L508.768 119.112H508.696L506.464 130.848C511.504 132.36 516.256 132.72 519.64 132.72ZM568.972 125.304C567.532 125.88 566.308 126.096 564.724 126.096C559.396 126.096 557.452 123 557.452 114.648V97.872H567.604V96.72H557.452V82.104L537.508 97.8V97.872H543.052V118.32C543.052 127.68 546.436 132.72 555.004 132.72C561.628 132.72 566.38 129.624 569.044 125.376L568.972 125.304ZM603.207 130.848V110.904C603.207 100.464 598.383 95.28 589.311 95.28C582.111 95.28 576.783 98.232 571.887 103.704L572.247 104.064C574.695 102.192 576.927 101.328 580.167 101.328C585.639 101.328 588.807 105.288 588.807 113.208C576.855 114.504 569.799 118.896 569.799 125.52C569.799 130.056 572.967 132.72 577.647 132.72C581.607 132.72 585.423 130.776 588.807 127.896V132H606.807V130.848H603.207ZM587.151 127.104C584.271 127.104 582.831 125.304 582.831 121.92C582.831 118.104 584.487 115.368 588.807 114.144V126.888C588.159 127.032 587.583 127.104 587.151 127.104ZM627.983 132.72C634.391 132.72 639.647 130.488 642.887 125.592L642.815 125.52C642.167 125.736 641.591 125.808 640.655 125.808C630.503 125.808 619.127 113.568 619.127 101.976C619.127 99.384 620.207 98.088 622.007 98.088C626.327 98.088 632.591 105 639.287 117.672H639.359L642.167 97.584C637.487 95.856 633.887 95.28 629.783 95.28C617.543 95.28 609.983 104.136 609.911 114.72C609.839 125.808 618.191 132.72 627.983 132.72ZM689.447 130.848L673.823 107.88L678.215 105.936C682.967 103.848 686.351 101.76 686.351 98.88C686.351 98.16 686.207 97.656 685.775 97.08H671.375V97.44C673.679 98.592 674.471 100.68 674.471 102.552C674.471 105.792 672.743 107.52 669.215 110.112L663.743 114.072V78L645.239 84.48L649.343 88.008V130.848H645.743V132H665.903V130.848H663.743V115.224L674.471 132H692.399V130.848H689.447ZM170.264 216.848V164L151.76 170.48L155.864 174.008V183.944C153.632 182.432 151.04 181.28 147.224 181.28C137.36 181.28 130.52 189.704 130.52 201.656C130.52 212.744 135.992 218.72 143.336 218.72C147.584 218.72 152.048 216.2 155.864 212.312V218H173.864V216.848H170.264ZM152.84 212.024C148.016 212.024 145.928 207.2 145.928 197.552C145.928 188.624 148.592 184.088 152.336 184.088C153.56 184.088 154.856 184.448 155.864 185.168V211.304C154.856 211.736 153.92 212.024 152.84 212.024ZM209.973 211.448C209.325 211.592 208.605 211.664 207.885 211.664C203.061 211.664 197.877 209 193.773 204.968C202.413 201.728 207.021 196.472 207.021 190.496C207.021 185.24 202.341 181.28 195.573 181.28C184.053 181.28 176.997 189.992 176.997 200.504C176.997 211.664 185.349 218.72 195.501 218.72C202.197 218.72 207.021 216.128 210.045 211.52L209.973 211.448ZM188.877 183.8C191.973 183.8 196.149 189.128 196.149 195.392C196.149 199.064 195.357 201.944 193.341 204.536C189.021 200.072 185.925 194.024 185.925 188.048C185.925 185.384 187.005 183.8 188.877 183.8ZM225.734 218.72C234.59 218.72 242.15 214.112 242.15 206.624C242.15 202.16 239.558 198.56 234.59 195.896L229.19 193.016C224.942 190.784 223.79 188.984 223.79 186.464C223.79 184.448 225.374 182.648 228.542 182.648C228.902 182.648 229.406 182.72 229.766 182.864L238.118 194.744H238.19L240.998 183.368C237.47 182.072 233.726 181.28 229.046 181.28C219.47 181.28 213.566 186.032 213.566 193.304C213.566 198.776 216.446 202.16 222.422 205.328L227.174 207.848C230.198 209.432 231.494 210.656 231.494 212.816C231.494 215.768 229.334 217.424 226.166 217.424C225.302 217.424 224.798 217.352 223.79 217.064L214.862 205.112H214.79L212.558 216.848C217.598 218.36 222.35 218.72 225.734 218.72ZM255.41 179.336C260.522 179.336 263.402 176.096 263.402 171.272C263.402 166.52 260.522 163.28 255.41 163.28C250.298 163.28 247.418 166.52 247.418 171.272C247.418 176.096 250.298 179.336 255.41 179.336ZM244.61 218H266.21V216.848H262.61V180.56L244.106 187.04L248.21 190.568V216.848H244.61V218ZM308.18 177.392C303.86 179.624 299.9 181.64 296.012 183.728C293.492 182.144 290.252 181.28 286.436 181.28C275.996 181.28 269.948 187.616 269.948 195.536C269.948 200.216 271.892 203.96 275.132 206.408C270.884 210.728 269.228 214.184 269.228 218.144C269.228 220.736 269.948 222.896 271.532 224.48C268.508 225.632 266.78 227.576 266.78 229.736C266.78 234.272 271.964 236.432 282.548 236.432C295.796 236.432 304.724 231.104 304.724 222.896C304.724 216.632 300.188 214.04 291.836 214.04H283.556C277.292 214.04 275.06 211.016 275.78 206.912C278.588 208.784 282.188 209.864 286.22 209.864C296.156 209.864 302.132 203.744 302.132 195.608C302.132 190.856 300.332 186.896 296.948 184.376C300.188 185.096 304.796 187.328 308.18 189.344L308.252 189.272V177.464L308.18 177.392ZM291.476 207.776C289.316 207.776 286.58 205.472 282.404 197.768C279.524 192.44 278.084 188.912 278.084 186.392C278.084 184.376 279.38 183.224 280.892 183.224C283.124 183.224 285.644 185.672 289.892 193.232C292.916 198.632 294.212 202.304 294.212 204.608C294.212 206.696 293.132 207.776 291.476 207.776ZM281.18 227.432H288.956C294.644 227.432 296.732 228.296 296.732 229.952C296.732 232.616 292.34 234.632 286.796 234.632C279.452 234.632 273.692 231.536 271.964 224.84C273.908 226.496 276.932 227.432 281.18 227.432ZM351.041 216.848V192.08C351.041 184.736 347.873 180.92 341.753 180.92C336.857 180.92 332.681 183.728 328.001 187.76V180.56L309.497 187.04L313.601 190.568V216.848H310.001V218H330.881V216.848H328.001V188.768C329.441 188.12 330.881 187.688 332.321 187.688C335.273 187.688 336.641 189.56 336.641 195.176V216.848H333.761V218H354.641V216.848H351.041ZM390.746 211.448C390.098 211.592 389.378 211.664 388.658 211.664C383.834 211.664 378.65 209 374.546 204.968C383.186 201.728 387.794 196.472 387.794 190.496C387.794 185.24 383.114 181.28 376.346 181.28C364.826 181.28 357.77 189.992 357.77 200.504C357.77 211.664 366.122 218.72 376.274 218.72C382.97 218.72 387.794 216.128 390.818 211.52L390.746 211.448ZM369.65 183.8C372.746 183.8 376.922 189.128 376.922 195.392C376.922 199.064 376.13 201.944 374.114 204.536C369.794 200.072 366.698 194.024 366.698 188.048C366.698 185.384 367.778 183.8 369.65 183.8ZM422.995 181.208C419.683 181.208 415.003 184.592 410.899 189.992V180.992L392.395 187.184L396.499 190.712V216.848H392.899V218H416.299V216.848H410.899V190.784C413.419 190.352 416.803 192.224 424.291 200.504H424.363V181.424C423.931 181.28 423.499 181.208 422.995 181.208ZM494.145 182.72L499.689 186.248L492.201 205.76L484.713 181.28L470.889 184.088L473.913 191.72L468.801 205.688L462.177 186.248L467.001 182.72H441.945L446.769 186.248L461.457 219.08H463.257L475.281 195.032L484.857 219.08H486.585L503.361 186.248L508.185 182.72H494.145ZM520.348 179.336C525.46 179.336 528.34 176.096 528.34 171.272C528.34 166.52 525.46 163.28 520.348 163.28C515.236 163.28 512.356 166.52 512.356 171.272C512.356 176.096 515.236 179.336 520.348 179.336ZM509.548 218H531.148V216.848H527.548V180.56L509.044 187.04L513.148 190.568V216.848H509.548V218ZM564.262 211.304C562.822 211.88 561.598 212.096 560.014 212.096C554.686 212.096 552.742 209 552.742 200.648V183.872H562.894V182.72H552.742V168.104L532.798 183.8V183.872H538.342V204.32C538.342 213.68 541.726 218.72 550.294 218.72C556.918 218.72 561.67 215.624 564.334 211.376L564.262 211.304ZM606.416 216.848V192.08C606.416 184.736 603.248 180.92 597.128 180.92C592.232 180.92 588.056 183.728 583.376 187.76V164L564.872 170.48L568.976 174.008V216.848H565.376V218H586.256V216.848H583.376V188.768C584.816 188.12 586.256 187.688 587.696 187.688C590.648 187.688 592.016 189.56 592.016 195.176V216.848H589.136V218H610.016V216.848H606.416ZM658.184 181.28C653.936 181.28 649.472 183.8 645.656 187.688V164L627.152 170.48L631.256 174.008V215.984C636.512 217.64 643.856 218.72 649.04 218.72C663.44 218.72 671 211.376 671 198.344C671 187.184 665.456 181.28 658.184 181.28ZM649.184 217.28C647.96 217.28 646.664 216.92 645.656 216.2V188.696C646.664 188.264 647.6 187.976 648.68 187.976C653.504 187.976 655.592 192.8 655.592 202.448C655.592 212.816 652.928 217.28 649.184 217.28ZM707.551 216.848V196.904C707.551 186.464 702.727 181.28 693.655 181.28C686.455 181.28 681.127 184.232 676.231 189.704L676.591 190.064C679.039 188.192 681.271 187.328 684.511 187.328C689.983 187.328 693.151 191.288 693.151 199.208C681.199 200.504 674.143 204.896 674.143 211.52C674.143 216.056 677.311 218.72 681.991 218.72C685.951 218.72 689.767 216.776 693.151 213.896V218H711.151V216.848H707.551ZM691.495 213.104C688.615 213.104 687.175 211.304 687.175 207.92C687.175 204.104 688.831 201.368 693.151 200.144V212.888C692.503 213.032 691.927 213.104 691.495 213.104ZM713.806 218H735.406V216.848H731.806V164L713.302 170.48L717.406 174.008V216.848H713.806V218ZM738.063 218H759.663V216.848H756.063V164L737.559 170.48L741.663 174.008V216.848H738.063V218ZM775.929 218.72C784.785 218.72 792.345 214.112 792.345 206.624C792.345 202.16 789.753 198.56 784.785 195.896L779.385 193.016C775.137 190.784 773.985 188.984 773.985 186.464C773.985 184.448 775.569 182.648 778.737 182.648C779.097 182.648 779.601 182.72 779.961 182.864L788.313 194.744H788.385L791.193 183.368C787.665 182.072 783.921 181.28 779.241 181.28C769.665 181.28 763.761 186.032 763.761 193.304C763.761 198.776 766.641 202.16 772.617 205.328L777.369 207.848C780.393 209.432 781.689 210.656 781.689 212.816C781.689 215.768 779.529 217.424 776.361 217.424C775.497 217.424 774.993 217.352 773.985 217.064L765.057 205.112H764.985L762.753 216.848C767.793 218.36 772.545 218.72 775.929 218.72ZM802.51 219.08C806.686 219.08 809.422 216.416 809.422 212.096C809.422 207.776 806.686 205.112 802.51 205.112C798.334 205.112 795.598 207.776 795.598 212.096C795.598 216.416 798.334 219.08 802.51 219.08ZM820.65 219.08C824.826 219.08 827.562 216.416 827.562 212.096C827.562 207.776 824.826 205.112 820.65 205.112C816.474 205.112 813.738 207.776 813.738 212.096C813.738 216.416 816.474 219.08 820.65 219.08ZM838.791 219.08C842.967 219.08 845.703 216.416 845.703 212.096C845.703 207.776 842.967 205.112 838.791 205.112C834.615 205.112 831.879 207.776 831.879 212.096C831.879 216.416 834.615 219.08 838.791 219.08Z" fill="white"/><path d="M131.42 267.18C132.5 267.18 133.4 266.31 133.4 265.11C133.4 263.91 132.5 263.07 131.42 263.07C130.31 263.07 129.38 263.91 129.38 265.11C129.38 266.31 130.31 267.18 131.42 267.18ZM138.217 267.18C139.297 267.18 140.197 266.31 140.197 265.11C140.197 263.91 139.297 263.07 138.217 263.07C137.107 263.07 136.177 263.91 136.177 265.11C136.177 266.31 137.107 267.18 138.217 267.18ZM145.014 267.18C146.094 267.18 146.994 266.31 146.994 265.11C146.994 263.91 146.094 263.07 145.014 263.07C143.904 263.07 142.974 263.91 142.974 265.11C142.974 266.31 143.904 267.18 145.014 267.18ZM161.375 251.1L155.885 263.82L150.335 251.1H147.335L154.355 266.97L153.845 268.08C153.065 269.91 152.195 270.54 150.815 270.54C149.735 270.54 148.745 270.12 147.965 269.37L146.735 271.53C147.725 272.49 149.285 273 150.815 273C153.245 273 155.075 271.95 156.485 268.59L164.195 251.1H161.375ZM173.253 267.18C178.023 267.18 181.503 263.79 181.503 259.05C181.503 254.31 178.023 250.95 173.253 250.95C168.483 250.95 164.973 254.31 164.973 259.05C164.973 263.79 168.483 267.18 173.253 267.18ZM173.253 264.66C170.193 264.66 167.883 262.44 167.883 259.05C167.883 255.66 170.193 253.47 173.253 253.47C176.313 253.47 178.593 255.66 178.593 259.05C178.593 262.44 176.313 264.66 173.253 264.66ZM197.426 251.1V259.32C197.426 262.74 195.506 264.6 192.506 264.6C189.776 264.6 188.216 263.04 188.216 259.92V251.1H185.336V260.25C185.336 264.93 188.066 267.18 192.176 267.18C194.426 267.18 196.406 266.25 197.576 264.6V267H200.306V251.1H197.426ZM220.775 267.18C223.625 267.18 225.995 265.98 227.255 263.76L225.065 262.38C224.045 263.94 222.485 264.66 220.745 264.66C217.625 264.66 215.285 262.5 215.285 259.05C215.285 255.66 217.625 253.47 220.745 253.47C222.485 253.47 224.045 254.19 225.065 255.75L227.255 254.34C225.995 252.12 223.625 250.95 220.775 250.95C215.885 250.95 212.375 254.31 212.375 259.05C212.375 263.79 215.885 267.18 220.775 267.18ZM236.774 250.95C234.224 250.95 231.854 251.67 230.204 252.99L231.404 255.15C232.634 254.1 234.554 253.44 236.444 253.44C239.294 253.44 240.704 254.85 240.704 257.28V257.85H236.144C231.404 257.85 229.754 259.95 229.754 262.5C229.754 265.26 232.034 267.18 235.634 267.18C238.124 267.18 239.894 266.34 240.854 264.9V267H243.584V257.4C243.584 253.05 241.124 250.95 236.774 250.95ZM236.114 264.96C233.924 264.96 232.604 263.97 232.604 262.38C232.604 261.03 233.414 259.92 236.264 259.92H240.704V262.14C239.984 263.97 238.274 264.96 236.114 264.96ZM257.404 250.95C254.884 250.95 252.844 251.88 251.674 253.5V251.1H248.914V267H251.794V258.81C251.794 255.36 253.774 253.53 256.834 253.53C259.564 253.53 261.124 255.06 261.124 258.18V267H264.004V257.85C264.004 253.17 261.274 250.95 257.404 250.95ZM285.43 264C284.83 264.48 284.02 264.75 283.18 264.75C281.59 264.75 280.69 263.79 280.69 262.08V253.47H285.25V251.1H280.69V247.62H277.81V251.1H275.11V253.47H277.81V262.2C277.81 265.41 279.64 267.18 282.85 267.18C284.14 267.18 285.46 266.82 286.33 266.07L285.43 264ZM298.302 250.95C295.872 250.95 293.892 251.82 292.692 253.35V244.74H289.812V267H292.692V258.81C292.692 255.36 294.672 253.53 297.732 253.53C300.462 253.53 302.022 255.06 302.022 258.18V267H304.902V257.85C304.902 253.17 302.172 250.95 298.302 250.95ZM312.992 253.77V251.1H310.232V267H313.112V259.08C313.112 255.6 315.032 253.71 318.122 253.71C318.332 253.71 318.542 253.71 318.782 253.74V250.95C315.992 250.95 314.012 251.91 312.992 253.77ZM328.995 267.18C333.765 267.18 337.245 263.79 337.245 259.05C337.245 254.31 333.765 250.95 328.995 250.95C324.225 250.95 320.715 254.31 320.715 259.05C320.715 263.79 324.225 267.18 328.995 267.18ZM328.995 264.66C325.935 264.66 323.625 262.44 323.625 259.05C323.625 255.66 325.935 253.47 328.995 253.47C332.055 253.47 334.335 255.66 334.335 259.05C334.335 262.44 332.055 264.66 328.995 264.66ZM362.269 251.1L357.529 263.82L352.819 251.1H350.389L345.589 263.76L340.969 251.1H338.239L344.149 267H346.909L351.559 254.94L356.149 267H358.909L364.849 251.1H362.269ZM397.308 251.1L392.568 263.82L387.858 251.1H385.428L380.628 263.76L376.008 251.1H373.278L379.188 267H381.948L386.598 254.94L391.188 267H393.948L399.888 251.1H397.308ZM404.25 248.04C405.39 248.04 406.2 247.2 406.2 246.12C406.2 245.1 405.36 244.29 404.25 244.29C403.14 244.29 402.3 245.13 402.3 246.18C402.3 247.23 403.14 248.04 404.25 248.04ZM402.81 267H405.69V251.1H402.81V267ZM419.229 264C418.629 264.48 417.819 264.75 416.979 264.75C415.389 264.75 414.489 263.79 414.489 262.08V253.47H419.049V251.1H414.489V247.62H411.609V251.1H408.909V253.47H411.609V262.2C411.609 265.41 413.439 267.18 416.649 267.18C417.939 267.18 419.259 266.82 420.129 266.07L419.229 264ZM432.101 250.95C429.671 250.95 427.691 251.82 426.491 253.35V244.74H423.611V267H426.491V258.81C426.491 255.36 428.471 253.53 431.531 253.53C434.261 253.53 435.821 255.06 435.821 258.18V267H438.701V257.85C438.701 253.17 435.971 250.95 432.101 250.95ZM457.877 250.95C455.327 250.95 452.957 251.67 451.307 252.99L452.507 255.15C453.737 254.1 455.657 253.44 457.547 253.44C460.397 253.44 461.807 254.85 461.807 257.28V257.85H457.247C452.507 257.85 450.857 259.95 450.857 262.5C450.857 265.26 453.137 267.18 456.737 267.18C459.227 267.18 460.997 266.34 461.957 264.9V267H464.687V257.4C464.687 253.05 462.227 250.95 457.877 250.95ZM457.217 264.96C455.027 264.96 453.707 263.97 453.707 262.38C453.707 261.03 454.517 259.92 457.367 259.92H461.807V262.14C461.087 263.97 459.377 264.96 457.217 264.96ZM625.131 267.18C626.211 267.18 627.111 266.31 627.111 265.11C627.111 263.91 626.211 263.07 625.131 263.07C624.021 263.07 623.091 263.91 623.091 265.11C623.091 266.31 624.021 267.18 625.131 267.18Z" fill="white"/>
        <path d="M485.004 267.18C487.854 267.18 490.224 265.98 491.484 263.76L489.294 262.38C488.274 263.94 486.714 264.66 484.974 264.66C481.854 264.66 479.514 262.5 479.514 259.05C479.514 255.66 481.854 253.47 484.974 253.47C486.714 253.47 488.274 254.19 489.294 255.75L491.484 254.34C490.224 252.12 487.854 250.95 485.004 250.95C480.114 250.95 476.604 254.31 476.604 259.05C476.604 263.79 480.114 267.18 485.004 267.18ZM495.007 267H497.887V244.74H495.007V267ZM504.826 248.04C505.966 248.04 506.776 247.2 506.776 246.12C506.776 245.1 505.936 244.29 504.826 244.29C503.716 244.29 502.876 245.13 502.876 246.18C502.876 247.23 503.716 248.04 504.826 248.04ZM503.386 267H506.266V251.1H503.386V267ZM518.695 267.18C521.545 267.18 523.915 265.98 525.175 263.76L522.985 262.38C521.965 263.94 520.405 264.66 518.665 264.66C515.545 264.66 513.205 262.5 513.205 259.05C513.205 255.66 515.545 253.47 518.665 253.47C520.405 253.47 521.965 254.19 522.985 255.75L525.175 254.34C523.915 252.12 521.545 250.95 518.695 250.95C513.805 250.95 510.295 254.31 510.295 259.05C510.295 263.79 513.805 267.18 518.695 267.18ZM540.849 267H544.389L537.039 257.67L543.729 251.1H540.249L531.579 259.02V244.74H528.699V267H531.579V262.65L534.879 259.59L540.849 267ZM563.732 250.95C561.302 250.95 559.322 251.82 558.122 253.35V244.74H555.242V267H558.122V258.81C558.122 255.36 560.102 253.53 563.162 253.53C565.892 253.53 567.452 255.06 567.452 258.18V267H570.332V257.85C570.332 253.17 567.602 250.95 563.732 250.95ZM590.12 259.14C590.12 254.25 586.85 250.95 582.26 250.95C577.67 250.95 574.28 254.34 574.28 259.05C574.28 263.79 577.7 267.18 582.83 267.18C585.47 267.18 587.66 266.28 589.1 264.6L587.51 262.74C586.34 264.03 584.78 264.66 582.92 264.66C579.77 264.66 577.52 262.8 577.16 260.01H590.06C590.09 259.74 590.12 259.38 590.12 259.14ZM582.26 253.38C585.05 253.38 587.06 255.27 587.36 257.94H577.16C577.46 255.24 579.5 253.38 582.26 253.38ZM596.879 253.77V251.1H594.119V267H596.999V259.08C596.999 255.6 598.919 253.71 602.009 253.71C602.219 253.71 602.429 253.71 602.669 253.74V250.95C599.879 250.95 597.899 251.91 596.879 253.77ZM620.442 259.14C620.442 254.25 617.172 250.95 612.582 250.95C607.992 250.95 604.602 254.34 604.602 259.05C604.602 263.79 608.022 267.18 613.152 267.18C615.792 267.18 617.982 266.28 619.422 264.6L617.832 262.74C616.662 264.03 615.102 264.66 613.242 264.66C610.092 264.66 607.842 262.8 607.482 260.01H620.382C620.412 259.74 620.442 259.38 620.442 259.14ZM612.582 253.38C615.372 253.38 617.382 255.27 617.682 257.94H607.482C607.782 255.24 609.822 253.38 612.582 253.38Z" fill="#FFC164"/>
        <path d="M475.344 270H621.702V271.5H475.344V270Z" fill="#FFC164"/>
        </svg>`
    );
  }
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////////////////////////////////////////
  // GUI
  var text1, text2, text3, text4, text5;

  function addGUI() {
    var instrumentation = new BABYLON.EngineInstrumentation(engine);
    instrumentation.captureGPUFrameTime = true;
    instrumentation.captureShaderCompilationTime = true;

    var i = 0;
    scene.registerBeforeRender(function() {
      // colorGrading.level = Math.sin(i++ / 120) * 0.5 + 0.5;

      text1 =
        "current frame time (GPU): " +
        (instrumentation.gpuFrameTimeCounter.current * 0.000001).toFixed(2) +
        "ms";
      text2 =
        "average frame time (GPU): " +
        (instrumentation.gpuFrameTimeCounter.average * 0.000001).toFixed(2) +
        "ms";
      text3 =
        "total shader compilation time: " +
        instrumentation.shaderCompilationTimeCounter.total.toFixed(2) +
        "ms";
      text4 =
        "average shader compilation time: " +
        instrumentation.shaderCompilationTimeCounter.average.toFixed(2) +
        "ms";
      text5 =
        "compiler shaders count: " +
        instrumentation.shaderCompilationTimeCounter.count;
    });
  }
</script>

<style>
  canvas {
    width: 100vw;
    height: 100vh;
    /* height: 33vw; */
    outline: none;
    position: fixed;
    top: 0;
    left: 0;

    /* position: absolute; */
  }
  p {
    z-index: 10;
    color: red;
    position: relative;
  }
</style>

<svelte:head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js" on:load={cannonLoaded}>

  </script>
</svelte:head>
<svelte:window on:resize={onResize} bind:scrollY={scrollPos} />
{#if DEBUG_VIEW}
  <p>{text1}</p>
  <p>{text2}</p>
  <p>{text3}</p>
  <p>{text4}</p>
  <p>{text5}</p>
{/if}

<canvas
  bind:this={myCanvas}
  style="pointer-events: {clickable ? 'inherit' : 'none'};z-index:{zFront ? '9200' : '0'}" />
